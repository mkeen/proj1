FROM debian:jessie
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    libapr1 \
    libaprutil1 \
    libapr1-dev \
    libaprutil1-dev \
    libpcre++0 \
    libssl1.0.0 \
    wget \
    ca-certificates \
    bzip2 \
    gcc \
    libpcre++-dev \
    libssl-dev \
    openssl \
    make
ENV HTTPD_PREFIX /usr/local/apache2
ENV PATH $PATH:$HTTPD_PREFIX/bin
RUN mkdir -p "$HTTPD_PREFIX" \
    && chown www-data:www-data "$HTTPD_PREFIX"
RUN mkdir /src
RUN mkdir /src/apache
WORKDIR /src/apache
RUN wget http://www-us.apache.org/dist//httpd/httpd-2.4.18.tar.gz
RUN tar -xzf httpd-2.4.18.tar.gz
WORKDIR httpd-2.4.18
RUN ./configure --with-mpm=event --enable-so --enable-ssl --prefix=$HTTPD_PREFIX
RUN make -j"$(nproc)"
RUN make install
WORKDIR $HTTPD_PREFIX
RUN openssl req \
    -new \
    -newkey rsa:2048 \
    -days 365 \
    -nodes \
    -x509 \
    -subj "/C=US/ST=Mike/L=Keen/O=Project1/CN=project1.xyz" \
    -keyout /usr/local/apache2/project1.key \
    -out  /usr/local/apache2/project1.crt
COPY ./docker/httpd.conf $HTTPD_PREFIX/conf
COPY ./docker/httpd-foreground /usr/local/bin/
COPY ./app $HTTPD_PREFIX/htdocs/
RUN chmod 777 /usr/local/bin/httpd-foreground
EXPOSE 80
EXPOSE 443
CMD ["/usr/local/bin/httpd-foreground"]
